---
import BookGrid from '../components/BookGrid.astro';
import FilterBar from '../components/FilterBar.astro';
import librosData from '../data/libros.json';
import '../styles/global.css';
import { readFileSync } from 'fs';
import { join } from 'path';

// Leer CSS crítico para inlinarlo
const criticalCSS = readFileSync(join(process.cwd(), 'src/styles/critical.css'), 'utf-8');

const totalLibros = librosData.length;
const librosLeidos = librosData.filter(book => book.readDate).length;
const librosPendientes = totalLibros - librosLeidos;

// SEO metadata
const siteTitle = 'Libros | FIL GDL 2025';
const siteDescription = `Colección de ${totalLibros} libros adquiridos en la Feria Internacional del Libro de Guadalajara 2025. Los libros leídos (${librosLeidos}) se muestran a color, mientras que los pendientes (${librosPendientes}) aparecen en escala de grises.`;
const siteUrl = 'https://fil25.vic.monster'; // Actualizar con la URL real del sitio
const siteImage = `${siteUrl}/books/7_ensayos.webp`; // Imagen representativa
---

<html lang="es">
	<head>
		<meta charset="utf-8" />
		<link rel="icon" type="image/svg+xml" href="/favicon.svg" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<meta name="generator" content={Astro.generator} />
		
		<!-- Preload critical fonts -->
		<link rel="preload" href="/fonts/Urbanist-Variable.woff2" as="font" type="font/woff2" crossorigin="anonymous" />
		
		<!-- Critical CSS inline -->
		<style set:html={criticalCSS} />
		
		<!-- Primary Meta Tags -->
		<title>{siteTitle}</title>
		<meta name="title" content={siteTitle} />
		<meta name="description" content={siteDescription} />
		<meta name="author" content="Vic" />
		
		<!-- Open Graph / Facebook -->
		<meta property="og:type" content="website" />
		<meta property="og:url" content={siteUrl} />
		<meta property="og:title" content={siteTitle} />
		<meta property="og:description" content={siteDescription} />
		<meta property="og:image" content={siteImage} />
		<meta property="og:locale" content="es_MX" />
		<meta property="og:site_name" content="FIL 2025 - Libros" />
		
		<!-- Twitter -->
		<meta name="twitter:card" content="summary_large_image" />
		<meta name="twitter:url" content={siteUrl} />
		<meta name="twitter:title" content={siteTitle} />
		<meta name="twitter:description" content={siteDescription} />
		<meta name="twitter:image" content={siteImage} />
		
		<!-- Schema.org JSON-LD -->
		<script type="application/ld+json" set:html={JSON.stringify({
			"@context": "https://schema.org",
			"@type": "CollectionPage",
			"name": siteTitle,
			"description": siteDescription,
			"url": siteUrl,
			"image": siteImage,
			"mainEntity": {
				"@type": "ItemList",
				"numberOfItems": totalLibros,
				"itemListElement": librosData.map((book, index) => ({
					"@type": "ListItem",
					"position": index + 1,
					"item": {
						"@type": "Book",
						"name": book.title,
						"description": book.subtitle || `${book.title} por ${book.author.join(', ')}`,
						"author": book.author.map(author => ({
							"@type": "Person",
							"name": author
						})),
						"publisher": book.publishers.map(publisher => ({
							"@type": "Organization",
							"name": publisher
						})),
						...(book.image && {
							"image": `${siteUrl}${book.image}`
						})
					}
				}))
			}
		})} />
		<style>
			.skip-link {
				position: absolute;
				top: -100px;
				left: 0;
				background: var(--text-primary);
				color: var(--bg);
				padding: 0.5rem 1rem;
				text-decoration: none;
				z-index: 100;
				font-weight: var(--font-weight-medium);
				clip: rect(0, 0, 0, 0);
				overflow: hidden;
			}
			.skip-link:focus {
				top: 0;
				clip: auto;
				overflow: visible;
				outline: 3px solid var(--text-primary);
				outline-offset: 2px;
			}
		</style>
		<script is:inline>
			// Prevenir scroll automático al cargar si hay hash en la URL
			if (window.location.hash === '#main-content') {
				// Remover el hash sin hacer scroll
				history.replaceState(null, '', window.location.pathname + window.location.search);
			}
			
			// Manejar el click en el skip link
			document.addEventListener('DOMContentLoaded', function() {
				const skipLink = document.querySelector('.skip-link');
				const mainContent = document.getElementById('main-content');
				
				if (skipLink && mainContent) {
					skipLink.addEventListener('click', function(e) {
						e.preventDefault();
						mainContent.setAttribute('tabindex', '-1');
						mainContent.focus();
						mainContent.scrollIntoView({ behavior: 'smooth', block: 'start' });
						// Remover tabindex después de un momento para no interferir con la navegación normal
						setTimeout(() => {
							mainContent.removeAttribute('tabindex');
						}, 1000);
					});
				}
				
				// Registrar Service Worker
				if ('serviceWorker' in navigator) {
					navigator.serviceWorker.register('/sw.js').catch(() => {
						// Silenciar errores en desarrollo
					});
				}
			});
		</script>
	</head>
	<body>
	<a href="#main-content" class="skip-link">Saltar al contenido principal</a>
	<main id="main-content">
		<h1>Libros | Feria Internacional de Libro de Guadalajara 2025</h1>
		<p class="intro">
			Colección de {totalLibros} libros adquiridos en la Feria Internacional del Libro de Guadalajara 2025. 
			Los libros leídos ({librosLeidos}) se muestran a color, mientras que los pendientes ({librosPendientes}) aparecen en escala de grises.
		</p>
		<FilterBar books={librosData} />
		<BookGrid books={librosData} />
	</main>
	</body>
</html>
